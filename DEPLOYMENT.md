# Инструкция по развертыванию и обновлению бота

## Важные замечания о базе данных

⚠️ **КРИТИЧЕСКИЙ МОМЕНТ**: База данных (`f1bot.db`) содержит всю информацию о пользователях, ставках и результатах. При обновлении бота база данных **НЕ ДОЛЖНА** удаляться!

### Что сохраняется в базе данных:
- Список пользователей и их права доступа (`is_allowed`)
- Все ставки пользователей
- Результаты гонок
- Очки пользователей
- История гонок

### При обновлении бота на Bothost.ru:

1. **ВАЖНО**: База данных должна находиться в рабочей директории проекта
2. Файл `f1bot.db` находится в корне проекта и **НЕ** коммитится в git (в `.gitignore`)
3. При обновлении через git pull база данных **НЕ удаляется**, так как она не отслеживается git
4. **Проверьте настройки Bothost.ru**: Убедитесь, что рабочая директория сохраняется между пересборками

### Настройка пути к базе данных:

По умолчанию база данных создается в корне проекта (`f1bot.db`). Если при пересборке рабочая директория очищается, используйте переменную окружения `DATABASE_PATH` для указания постоянного пути:

```bash
# В панели Bothost.ru добавьте переменную окружения:
DATABASE_PATH=/app/data/f1bot.db
```

Или используйте абсолютный путь к постоянной директории на сервере.

### Проверка сохранности данных:

После обновления бота проверьте:
1. **Проверьте логи бота** - при запуске должны быть строки:
   ```
   Database file exists: f1bot.db
   Database initialized. Existing data:
     - Users: [количество]
     - Races: [количество]
     - Bets: [количество]
     - Results: [количество]
     - Points: [количество]
   ```
2. Запустите команду `/admin_users` - должны отображаться все пользователи с их статусом `is_allowed`
3. Проверьте команду `/admin_races` - должны отображаться все гонки
4. Проверьте команду `/my_bets` - должны отображаться все ваши ставки
5. Проверьте команду `/leaderboard` - должны отображаться все очки

**Если в логах видно "Database file does not exist" или все счетчики равны 0**, значит база данных была удалена или находится в неправильном месте.

### Если данные потерялись:

Если после обновления данные потерялись, это означает, что:
1. База данных была удалена вручную
2. Рабочая директория была очищена
3. База данных находилась в неправильном месте

**Решение**: Восстановите базу данных из резервной копии (если есть) или начните заново.

### Рекомендации:

1. **Регулярно делайте резервные копии** базы данных:
   ```bash
   cp f1bot.db f1bot.db.backup
   ```

2. **Проверяйте настройки Bothost.ru**:
   - Убедитесь, что рабочая директория сохраняется между обновлениями
   - Проверьте, что переменная окружения `DATABASE_PATH` указывает на правильный путь

3. **При обновлении через git**:
   ```bash
   git pull origin main
   # База данных автоматически сохранится
   ```

## Обновление бота

### Локальное обновление:

```bash
# Остановите бота
# Сделайте резервную копию базы данных
cp f1bot.db f1bot.db.backup

# Обновите код
git pull origin main

# Установите новые зависимости (если есть)
pip install -r requirements.txt

# Запустите бота
python bot.py
```

### Обновление на Bothost.ru:

1. Зайдите в панель управления Bothost.ru
2. Нажмите "Обновить" или "Deploy" (если настроен автоматический деплой из git)
3. Дождитесь завершения обновления
4. Проверьте логи бота на наличие ошибок
5. Проверьте работу бота через Telegram

**Важно**: База данных должна сохраниться автоматически, так как она находится в рабочей директории и не отслеживается git.

## Переменные окружения

Убедитесь, что все переменные окружения настроены правильно:

- `BOT_TOKEN` - токен бота от @BotFather (обязательно)
- `ADMIN_IDS` - ID администраторов (через запятую, обязательно)
- `DATABASE_PATH` - путь к базе данных (по умолчанию `f1bot.db`)
  - **Рекомендуется**: Используйте абсолютный путь к постоянной директории, если рабочая директория очищается при пересборке
  - Пример: `/app/data/f1bot.db` или `/var/lib/f1bot/f1bot.db`
- `DEFAULT_TIMEZONE` - часовой пояс (по умолчанию `UTC`)
- `BET_CLOSING_OFFSET` - время закрытия ставок в минутах до старта (по умолчанию `5`)

### Настройка постоянного пути к базе данных на Bothost.ru:

1. В панели управления Bothost.ru найдите раздел "Переменные окружения"
2. Добавьте переменную `DATABASE_PATH` со значением абсолютного пути
3. Убедитесь, что директория существует и доступна для записи
4. Пример: `DATABASE_PATH=/app/data/f1bot.db`

## Миграции базы данных

Бот автоматически выполняет миграции при запуске:
- Добавляет новые колонки, если их нет
- Сохраняет существующие данные
- Не удаляет существующие таблицы или данные

При первом запуске создаются все необходимые таблицы.

