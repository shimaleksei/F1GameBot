# Инструкция по развертыванию и обновлению бота

## Важные замечания о базе данных

⚠️ **КРИТИЧЕСКИЙ МОМЕНТ**: База данных (`f1bot.db`) содержит всю информацию о пользователях, ставках и результатах. При обновлении бота база данных **НЕ ДОЛЖНА** удаляться!

### Что сохраняется в базе данных:
- Список пользователей и их права доступа (`is_allowed`)
- Все ставки пользователей
- Результаты гонок
- Очки пользователей
- История гонок

### При обновлении бота на Bothost.ru:

1. **База данных сохраняется автоматически**, если она находится в рабочей директории проекта
2. Файл `f1bot.db` находится в корне проекта и **НЕ** коммитится в git (в `.gitignore`)
3. При обновлении через git pull база данных **НЕ удаляется**, так как она не отслеживается git

### Проверка сохранности данных:

После обновления бота проверьте:
1. Запустите команду `/admin_users` - должны отображаться все пользователи с их статусом `is_allowed`
2. Проверьте команду `/my_bets` - должны отображаться все ваши ставки
3. Проверьте команду `/leaderboard` - должны отображаться все очки

### Если данные потерялись:

Если после обновления данные потерялись, это означает, что:
1. База данных была удалена вручную
2. Рабочая директория была очищена
3. База данных находилась в неправильном месте

**Решение**: Восстановите базу данных из резервной копии (если есть) или начните заново.

### Рекомендации:

1. **Регулярно делайте резервные копии** базы данных:
   ```bash
   cp f1bot.db f1bot.db.backup
   ```

2. **Проверяйте настройки Bothost.ru**:
   - Убедитесь, что рабочая директория сохраняется между обновлениями
   - Проверьте, что переменная окружения `DATABASE_PATH` указывает на правильный путь

3. **При обновлении через git**:
   ```bash
   git pull origin main
   # База данных автоматически сохранится
   ```

## Обновление бота

### Локальное обновление:

```bash
# Остановите бота
# Сделайте резервную копию базы данных
cp f1bot.db f1bot.db.backup

# Обновите код
git pull origin main

# Установите новые зависимости (если есть)
pip install -r requirements.txt

# Запустите бота
python bot.py
```

### Обновление на Bothost.ru:

1. Зайдите в панель управления Bothost.ru
2. Нажмите "Обновить" или "Deploy" (если настроен автоматический деплой из git)
3. Дождитесь завершения обновления
4. Проверьте логи бота на наличие ошибок
5. Проверьте работу бота через Telegram

**Важно**: База данных должна сохраниться автоматически, так как она находится в рабочей директории и не отслеживается git.

## Переменные окружения

Убедитесь, что все переменные окружения настроены правильно:

- `BOT_TOKEN` - токен бота от @BotFather
- `ADMIN_IDS` - ID администраторов (через запятую)
- `DATABASE_PATH` - путь к базе данных (по умолчанию `f1bot.db`)
- `DEFAULT_TIMEZONE` - часовой пояс (по умолчанию `UTC`)
- `BET_CLOSING_OFFSET` - время закрытия ставок в минутах до старта (по умолчанию `5`)

## Миграции базы данных

Бот автоматически выполняет миграции при запуске:
- Добавляет новые колонки, если их нет
- Сохраняет существующие данные
- Не удаляет существующие таблицы или данные

При первом запуске создаются все необходимые таблицы.

